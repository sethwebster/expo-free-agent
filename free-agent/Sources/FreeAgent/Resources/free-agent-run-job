#!/bin/bash
#
# Free Agent VM Runner Script
# Lives at: /usr/local/bin/free-agent-run-job inside Tart VM
#
# Contract:
# - Input: --in ~/free-agent/in (contains source.tar.gz, optional signing.zip)
# - Output: ~/free-agent/out/artifact.ipa (MUST exist on success)
# - Output: ~/free-agent/out/xcodebuild.log (SHOULD exist, even on failure)
#

set -e
set -o pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }

# Stream logs to controller
stream_log() {
    local level="$1"
    local message="$2"

    # Only stream if we have controller credentials
    if [ -n "$CONTROLLER_URL" ] && [ -n "$BUILD_ID" ] && [ -n "$WORKER_ID" ] && [ -n "$API_KEY" ]; then
        # Send log to controller (async, don't block build)
        curl -s -X POST \
            "${CONTROLLER_URL}/api/builds/${BUILD_ID}/logs" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${API_KEY}" \
            -H "X-Worker-Id: ${WORKER_ID}" \
            -d "{\"level\":\"${level}\",\"message\":\"${message}\"}" \
            > /dev/null 2>&1 &
    fi
}

# Enhanced logging functions that stream to controller
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
    stream_log "info" "$1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
    stream_log "error" "$1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
    stream_log "warn" "$1"
}

# Parse arguments
IN_DIR=""
OUT_DIR=""

show_usage() {
    echo "Usage: $0 --in <input-dir> --out <output-dir>"
    echo ""
    echo "Free Agent VM Build Runner"
    echo ""
    echo "Arguments:"
    echo "  --in <dir>   Input directory containing:"
    echo "               - source.tar.gz (required)"
    echo "               - signing.zip (optional)"
    echo "  --out <dir>  Output directory for:"
    echo "               - artifact.ipa (produced on success)"
    echo "               - xcodebuild.log (always produced)"
    echo ""
    echo "Example:"
    echo "  $0 --in ~/free-agent/in --out ~/free-agent/out"
}

while [[ $# -gt 0 ]]; do
    case $1 in
        --help|-h)
            show_usage
            exit 0
            ;;
        --in)
            IN_DIR="$2"
            shift 2
            ;;
        --out)
            OUT_DIR="$2"
            shift 2
            ;;
        *)
            log_error "Unknown argument: $1"
            show_usage
            exit 1
            ;;
    esac
done

if [ -z "$IN_DIR" ] || [ -z "$OUT_DIR" ]; then
    log_error "Missing required arguments"
    show_usage
    exit 1
fi

# Expand paths
IN_DIR=$(eval echo "$IN_DIR")
OUT_DIR=$(eval echo "$OUT_DIR")
WORK_DIR="$HOME/free-agent/work"

log_info "Input: $IN_DIR"
log_info "Output: $OUT_DIR"
log_info "Work: $WORK_DIR"

# Ensure output directory exists
mkdir -p "$OUT_DIR"

# Redirect all output to log
exec > >(tee "$OUT_DIR/xcodebuild.log") 2>&1

log_info "=== Free Agent Build Runner ==="
log_info "Starting at: $(date)"
log_info "Node: $(node -v)"
log_info "npm: $(npm -v)"
log_info "Xcode: $(xcodebuild -version | head -1)"

# Step 1: Extract source
log_info "Extracting source..."
mkdir -p "$WORK_DIR"
cd "$WORK_DIR"

if [ ! -f "$IN_DIR/source.tar.gz" ]; then
    log_error "Source archive not found: $IN_DIR/source.tar.gz"
    exit 1
fi

tar -xzf "$IN_DIR/source.tar.gz" -C "$WORK_DIR"
log_info "✓ Source extracted"

# Step 2: Install dependencies
log_info "Installing dependencies..."
if [ -f "package.json" ]; then
    npm ci || npm install
    log_info "✓ Dependencies installed"
else
    log_warn "No package.json found, skipping npm install"
fi

# Step 3: Prebuild (generate native iOS project)
log_info "Running Expo prebuild..."
if [ -d "ios" ]; then
    log_warn "ios/ directory already exists, skipping prebuild"
else
    npx expo prebuild --platform ios --clean
    log_info "✓ Prebuild complete"
fi

# Step 4: Install CocoaPods dependencies
log_info "Installing CocoaPods..."
cd ios
pod install
log_info "✓ Pods installed"

# Step 5: Build with xcodebuild
log_info "Building with xcodebuild..."

# Find the .xcworkspace file
WORKSPACE=$(find . -name "*.xcworkspace" -maxdepth 1 | head -1)
if [ -z "$WORKSPACE" ]; then
    log_error "No .xcworkspace found"
    exit 1
fi

SCHEME=$(xcodebuild -workspace "$WORKSPACE" -list | grep -A 100 "Schemes:" | grep -v "Schemes:" | head -1 | xargs)
log_info "Using scheme: $SCHEME"

ARCHIVE_PATH="$WORK_DIR/build/App.xcarchive"
EXPORT_PATH="$WORK_DIR/build/export"

log_info "Archiving..."
xcodebuild archive \
    -workspace "$WORKSPACE" \
    -scheme "$SCHEME" \
    -configuration Release \
    -archivePath "$ARCHIVE_PATH" \
    -destination generic/platform=iOS \
    -allowProvisioningUpdates \
    | tee -a "$OUT_DIR/xcodebuild.log"

if [ ${PIPESTATUS[0]} -ne 0 ]; then
    log_error "Archive failed"
    exit 1
fi

log_info "✓ Archive complete"

# Step 6: Export IPA
log_info "Exporting IPA..."

# Create export options plist for signed build
cat > "$WORK_DIR/ExportOptions.plist" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>ad-hoc</string>
    <key>compileBitcode</key>
    <false/>
    <key>signingStyle</key>
    <string>automatic</string>
    <key>stripSwiftSymbols</key>
    <true/>
</dict>
</plist>
EOF

xcodebuild -exportArchive \
    -archivePath "$ARCHIVE_PATH" \
    -exportPath "$EXPORT_PATH" \
    -exportOptionsPlist "$WORK_DIR/ExportOptions.plist" \
    | tee -a "$OUT_DIR/xcodebuild.log"

if [ ${PIPESTATUS[0]} -ne 0 ]; then
    log_error "Export failed"
    exit 1
fi

log_info "✓ Export complete"

# Step 7: Copy artifact to output
log_info "Copying artifact..."

IPA=$(find "$EXPORT_PATH" -name "*.ipa" | head -1)
if [ -z "$IPA" ]; then
    log_error "No IPA found in export path"
    exit 1
fi

cp "$IPA" "$OUT_DIR/artifact.ipa"
log_info "✓ Artifact copied to $OUT_DIR/artifact.ipa"

# Optional: Create metadata
cat > "$OUT_DIR/build.json" <<EOF
{
    "success": true,
    "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "scheme": "$SCHEME",
    "artifact": "artifact.ipa"
}
EOF

log_info "=== Build Complete ==="
log_info "Finished at: $(date)"

exit 0
