#!/bin/bash
#
# free-agent-auto-update
#
# Auto-update wrapper for VM agent scripts.
# Runs at VM boot before bootstrap to ensure latest version.
#
# Responsibilities:
#   1. Check for updates from GitHub releases or controller
#   2. Download latest scripts if newer version available
#   3. Install updated scripts to /usr/local/bin/
#   4. Exec bootstrap script with updated version
#
# Exit Codes:
#   0: Success (updated or already latest)
#   1: Update failed (continues with existing version)
#

set -e
set -o pipefail

# Configuration
LOG_FILE="/tmp/free-agent-auto-update.log"
SCRIPTS_DIR="/usr/local/bin"
VERSION_FILE="/usr/local/etc/free-agent-version"
TEMP_DIR="/tmp/free-agent-update-$$"

# Download URL for latest scripts (can be overridden by env var)
DEFAULT_SCRIPTS_URL="https://github.com/sethwebster/expo-free-agent/releases/latest/download/vm-scripts.tar.gz"
SCRIPTS_URL="${FREE_AGENT_SCRIPTS_URL:-$DEFAULT_SCRIPTS_URL}"

# Scripts to update
SCRIPTS=(
    "free-agent-vm-bootstrap"
    "free-agent-run-job"
    "vm-monitor.sh"
    "install-signing-certs"
)

# Logging helper
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

# Error handler (non-fatal - continue with existing version)
error_continue() {
    log "WARNING: $1"
    log "Continuing with existing scripts version..."
    return 1
}

# Cleanup temp directory
cleanup() {
    if [[ -d "$TEMP_DIR" ]]; then
        rm -rf "$TEMP_DIR"
    fi
}
trap cleanup EXIT

# ========================================
# Phase 1: Check Current Version
# ========================================

log "=========================================="
log "Expo Free Agent - Auto Update"
log "=========================================="

CURRENT_VERSION="unknown"
if [[ -f "$VERSION_FILE" ]]; then
    CURRENT_VERSION=$(cat "$VERSION_FILE" 2>/dev/null || echo "unknown")
fi

log "Current version: $CURRENT_VERSION"
log "Checking for updates from: $SCRIPTS_URL"

# ========================================
# Phase 2: Download Latest Version
# ========================================

mkdir -p "$TEMP_DIR"

log "Downloading latest scripts..."
if ! curl -L -f -s -S \
    --max-time 30 \
    --retry 3 \
    --retry-delay 5 \
    -o "$TEMP_DIR/vm-scripts.tar.gz" \
    "$SCRIPTS_URL" 2>&1 | tee -a "$LOG_FILE"; then
    error_continue "Failed to download scripts"
    exec /usr/local/bin/free-agent-vm-bootstrap "$@"
fi

log "✓ Scripts downloaded"

# ========================================
# Phase 3: Extract and Validate
# ========================================

log "Extracting scripts..."
if ! tar -xzf "$TEMP_DIR/vm-scripts.tar.gz" -C "$TEMP_DIR" 2>&1 | tee -a "$LOG_FILE"; then
    error_continue "Failed to extract scripts"
    exec /usr/local/bin/free-agent-vm-bootstrap "$@"
fi

log "✓ Scripts extracted"

# Validate all required scripts exist
log "Validating extracted scripts..."
for script in "${SCRIPTS[@]}"; do
    if [[ ! -f "$TEMP_DIR/$script" ]]; then
        error_continue "Missing script in package: $script"
        exec /usr/local/bin/free-agent-vm-bootstrap "$@"
    fi
done

log "✓ All scripts present"

# Check version file
NEW_VERSION="unknown"
if [[ -f "$TEMP_DIR/VERSION" ]]; then
    NEW_VERSION=$(cat "$TEMP_DIR/VERSION" 2>/dev/null || echo "unknown")
fi

log "New version: $NEW_VERSION"

# Skip if already on latest version
if [[ "$CURRENT_VERSION" == "$NEW_VERSION" && "$NEW_VERSION" != "unknown" ]]; then
    log "Already on latest version ($CURRENT_VERSION), skipping update"
    exec /usr/local/bin/free-agent-vm-bootstrap "$@"
fi

# ========================================
# Phase 4: Install Updated Scripts
# ========================================

log "Installing updated scripts..."

# Backup existing scripts (in case of rollback need)
BACKUP_DIR="/tmp/free-agent-backup-$$"
mkdir -p "$BACKUP_DIR"

for script in "${SCRIPTS[@]}"; do
    if [[ -f "$SCRIPTS_DIR/$script" ]]; then
        cp "$SCRIPTS_DIR/$script" "$BACKUP_DIR/$script" 2>/dev/null || true
    fi
done

# Install new scripts
for script in "${SCRIPTS[@]}"; do
    log "Installing $script..."

    # Copy script
    if ! cp "$TEMP_DIR/$script" "$SCRIPTS_DIR/$script"; then
        error_continue "Failed to install $script"

        # Rollback
        log "Rolling back to previous version..."
        for s in "${SCRIPTS[@]}"; do
            if [[ -f "$BACKUP_DIR/$s" ]]; then
                cp "$BACKUP_DIR/$s" "$SCRIPTS_DIR/$s" 2>/dev/null || true
            fi
        done

        exec /usr/local/bin/free-agent-vm-bootstrap "$@"
    fi

    # Make executable
    chmod +x "$SCRIPTS_DIR/$script"

    log "✓ $script installed"
done

# Update version file
echo "$NEW_VERSION" > "$VERSION_FILE"
log "✓ Version file updated: $NEW_VERSION"

log "=========================================="
log "Auto-update complete! ($CURRENT_VERSION -> $NEW_VERSION)"
log "=========================================="

# ========================================
# Phase 5: Exec Bootstrap with Updated Version
# ========================================

log "Executing bootstrap script..."

# Exec bootstrap (replaces current process)
exec /usr/local/bin/free-agent-vm-bootstrap "$@"
