#!/bin/bash
#
# install-signing-certs
#
# Helper script to install iOS signing certificates and provisioning profiles.
# Parses JSON cert bundle, installs to macOS keychain, and configures for codesigning.
#
# Usage:
#   install-signing-certs --certs <path-to-certs.json>
#
# JSON Structure (expected):
#   {
#     "p12": "base64-encoded-p12-file",
#     "p12Password": "password-for-p12",
#     "keychainPassword": "random-keychain-password",
#     "provisioningProfiles": ["base64-profile1", "base64-profile2", ...]
#   }
#
# Responsibilities:
#   1. Parse JSON cert bundle
#   2. Decode base64 P12 and provisioning profiles
#   3. Create keychain with random password
#   4. Import P12 certificate
#   5. Configure keychain for codesign (partition list)
#   6. Install provisioning profiles
#   7. Securely delete P12 file
#   8. Verify installation
#
# Exit Codes:
#   0: Success
#   1: Invalid arguments
#   2: JSON parsing failed
#   3: P12 import failed
#   4: Keychain configuration failed
#   5: Profile installation failed
#   6: Verification failed
#

set -e
set -o pipefail

# Configuration
KEYCHAIN_NAME="build.keychain-db"
KEYCHAIN_PATH="$HOME/Library/Keychains/$KEYCHAIN_NAME"
PROFILES_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
TMP_P12="/tmp/cert-$$.p12"
TMP_PROFILE_PREFIX="/tmp/profile-$$"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Logging helpers
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"
}

error() {
    echo -e "${RED}ERROR: $*${NC}" >&2
}

success() {
    echo -e "${GREEN}✓ $*${NC}"
}

warning() {
    echo -e "${YELLOW}⚠ $*${NC}"
}

# Secure file deletion
secure_delete() {
    local file="$1"
    if [[ ! -f "$file" ]]; then
        return 0
    fi

    if command -v shred &> /dev/null; then
        shred -u -n 3 "$file" 2>/dev/null || rm -f "$file"
    else
        rm -f "$file"
    fi
}

# Cleanup on exit
cleanup() {
    log "Cleaning up temporary files..."
    secure_delete "$TMP_P12"
    rm -f "${TMP_PROFILE_PREFIX}"*.mobileprovision 2>/dev/null || true
}
trap cleanup EXIT

# Usage
usage() {
    cat << EOF
Usage: $(basename "$0") --certs <path-to-certs.json>

Install iOS signing certificates and provisioning profiles from JSON bundle.

Options:
  --certs <path>    Path to JSON cert bundle (required)
  --help            Show this help message

Example:
  $(basename "$0") --certs /tmp/certs-secure.json

EOF
    exit "${1:-0}"
}

# ========================================
# Argument Parsing
# ========================================

CERTS_FILE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --certs)
            CERTS_FILE="$2"
            shift 2
            ;;
        --help)
            usage 0
            ;;
        *)
            error "Unknown option: $1"
            usage 1
            ;;
    esac
done

if [[ -z "$CERTS_FILE" ]]; then
    error "Missing required argument: --certs"
    usage 1
fi

if [[ ! -f "$CERTS_FILE" ]]; then
    error "Cert bundle not found: $CERTS_FILE"
    exit 1
fi

log "=========================================="
log "iOS Signing Certificate Installer"
log "=========================================="

# ========================================
# Phase 1: Parse JSON Bundle
# ========================================

log "Phase 1: Parsing certificate bundle..."

if ! jq empty "$CERTS_FILE" 2>/dev/null; then
    error "Invalid JSON in cert bundle: $CERTS_FILE"
    exit 2
fi

# Extract values
P12_B64=$(jq -r '.p12' "$CERTS_FILE" 2>/dev/null || echo "")
P12_PASSWORD=$(jq -r '.p12Password' "$CERTS_FILE" 2>/dev/null || echo "")
KEYCHAIN_PASSWORD=$(jq -r '.keychainPassword' "$CERTS_FILE" 2>/dev/null || echo "")
PROFILES_COUNT=$(jq -r '.provisioningProfiles | length' "$CERTS_FILE" 2>/dev/null || echo "0")

# Validate required fields
if [[ -z "$P12_B64" || "$P12_B64" == "null" ]]; then
    error "Missing 'p12' field in cert bundle"
    exit 2
fi

if [[ -z "$KEYCHAIN_PASSWORD" || "$KEYCHAIN_PASSWORD" == "null" ]]; then
    error "Missing 'keychainPassword' field in cert bundle"
    exit 2
fi

log "✓ P12 certificate: ${#P12_B64} bytes (base64)"
log "✓ P12 password: ${P12_PASSWORD:+set}"
log "✓ Keychain password: ${#KEYCHAIN_PASSWORD} chars"
log "✓ Provisioning profiles: $PROFILES_COUNT"

# ========================================
# Phase 2: Decode P12
# ========================================

log "Phase 2: Decoding P12 certificate..."

if ! echo "$P12_B64" | base64 --decode > "$TMP_P12" 2>/dev/null; then
    error "Failed to decode base64 P12"
    exit 2
fi

if [[ ! -s "$TMP_P12" ]]; then
    error "Decoded P12 is empty"
    exit 2
fi

success "P12 decoded: $(stat -f%z "$TMP_P12") bytes"

# ========================================
# Phase 3: Create Keychain
# ========================================

log "Phase 3: Creating keychain..."

# Delete existing keychain if present
if [[ -f "$KEYCHAIN_PATH" ]]; then
    warning "Removing existing keychain: $KEYCHAIN_NAME"
    security delete-keychain "$KEYCHAIN_NAME" 2>/dev/null || true
    rm -f "$KEYCHAIN_PATH" 2>/dev/null || true
fi

# Create new keychain
if ! security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME" 2>/dev/null; then
    error "Failed to create keychain: $KEYCHAIN_NAME"
    exit 3
fi

success "Keychain created: $KEYCHAIN_NAME"

# Set keychain settings (no timeout, no lock)
security set-keychain-settings "$KEYCHAIN_NAME" 2>/dev/null || {
    error "Failed to configure keychain settings"
    exit 4
}

# Add to keychain search list
security list-keychains -d user -s "$KEYCHAIN_NAME" $(security list-keychains -d user | sed 's/"//g') 2>/dev/null || {
    error "Failed to add keychain to search list"
    exit 4
}

success "Keychain configured"

# ========================================
# Phase 4: Import P12
# ========================================

log "Phase 4: Importing P12 certificate..."

IMPORT_ARGS=(
    import
    "$TMP_P12"
    -k "$KEYCHAIN_NAME"
    -T /usr/bin/codesign
    -T /usr/bin/security
)

# Add password if provided
if [[ -n "$P12_PASSWORD" ]]; then
    IMPORT_ARGS+=(-P "$P12_PASSWORD")
fi

if ! security "${IMPORT_ARGS[@]}" 2>/dev/null; then
    error "Failed to import P12 certificate"
    exit 3
fi

success "P12 certificate imported"

# Shred P12 immediately
secure_delete "$TMP_P12"
success "P12 file securely deleted"

# ========================================
# Phase 5: Configure Partition List
# ========================================

log "Phase 5: Configuring keychain for codesigning..."

# Set partition list to allow codesign without prompting
if ! security set-key-partition-list \
    -S apple-tool:,apple: \
    -s \
    -k "$KEYCHAIN_PASSWORD" \
    "$KEYCHAIN_NAME" 2>/dev/null; then
    error "Failed to set partition list"
    exit 4
fi

success "Partition list configured (codesign allowed)"

# Unlock keychain
if ! security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME" 2>/dev/null; then
    error "Failed to unlock keychain"
    exit 4
fi

success "Keychain unlocked"

# Set as default keychain
security default-keychain -s "$KEYCHAIN_NAME" 2>/dev/null || {
    warning "Could not set as default keychain (non-fatal)"
}

# ========================================
# Phase 6: Install Provisioning Profiles
# ========================================

log "Phase 6: Installing provisioning profiles..."

# Create profiles directory if needed
mkdir -p "$PROFILES_DIR"

if [[ "$PROFILES_COUNT" -eq 0 ]]; then
    warning "No provisioning profiles to install"
else
    INSTALLED_COUNT=0

    for i in $(seq 0 $((PROFILES_COUNT - 1))); do
        PROFILE_B64=$(jq -r ".provisioningProfiles[$i]" "$CERTS_FILE" 2>/dev/null || echo "")

        if [[ -z "$PROFILE_B64" || "$PROFILE_B64" == "null" ]]; then
            warning "Skipping empty profile at index $i"
            continue
        fi

        # Decode profile
        TMP_PROFILE="${TMP_PROFILE_PREFIX}-${i}.mobileprovision"
        if ! echo "$PROFILE_B64" | base64 --decode > "$TMP_PROFILE" 2>/dev/null; then
            warning "Failed to decode profile at index $i"
            continue
        fi

        # Extract UUID from profile (for unique filename)
        PROFILE_UUID=$(security cms -D -i "$TMP_PROFILE" 2>/dev/null | plutil -extract UUID raw - 2>/dev/null || echo "unknown-$i")

        # Copy to profiles directory
        DEST_PROFILE="$PROFILES_DIR/$PROFILE_UUID.mobileprovision"
        if cp "$TMP_PROFILE" "$DEST_PROFILE" 2>/dev/null; then
            success "Profile installed: $PROFILE_UUID"
            INSTALLED_COUNT=$((INSTALLED_COUNT + 1))
        else
            warning "Failed to install profile at index $i"
        fi

        rm -f "$TMP_PROFILE"
    done

    if [[ $INSTALLED_COUNT -eq 0 ]]; then
        error "Failed to install any provisioning profiles"
        exit 5
    fi

    success "Installed $INSTALLED_COUNT/$PROFILES_COUNT provisioning profiles"
fi

# ========================================
# Phase 7: Verification
# ========================================

log "Phase 7: Verifying installation..."

# Check keychain exists
if ! security list-keychains -d user | grep -q "$KEYCHAIN_NAME"; then
    error "Keychain not in search list"
    exit 6
fi

success "Keychain in search list"

# Check for signing identities
IDENTITY_COUNT=$(security find-identity -v -p codesigning "$KEYCHAIN_NAME" 2>/dev/null | grep -c "^[[:space:]]*[0-9])" || echo "0")

if [[ $IDENTITY_COUNT -eq 0 ]]; then
    error "No signing identities found in keychain"
    exit 6
fi

success "Found $IDENTITY_COUNT signing identity(ies)"

# List identities
log "Available signing identities:"
security find-identity -v -p codesigning "$KEYCHAIN_NAME" 2>/dev/null | grep "^[[:space:]]*[0-9])" || true

# Check provisioning profiles
INSTALLED_PROFILES=$(find "$PROFILES_DIR" -name "*.mobileprovision" 2>/dev/null | wc -l | tr -d ' ')
log "Provisioning profiles in library: $INSTALLED_PROFILES"

log "=========================================="
log "Installation complete!"
log "=========================================="

exit 0
