# Code Review: Expo Free Agent - Transition to Production Mode

**Date:** 2026-01-23
**Focus:** Assess readiness for real builds vs mock/prototype mode

---

## Executive Summary

The codebase is well-structured with working controller (30 tests), CLI (28 tests), and compiling Swift app. However, **the system has never executed a real build**. The Free Agent Swift app compiles but has critical bugs that will prevent it from working with actual VMs. The mock worker proves the API protocol works, but real VM automation requires significant additional work.

**Critical Path to First Real Build:**
1. Fix 5 critical Swift bugs (1.5 hours)
2. Create/configure a macOS VM image (2-4 hours manual setup)
3. Test VM boot/SSH connectivity (1 hour)
4. Run first real build with minimal Expo app (2-4 hours debugging expected)

---

## RED Critical Issues

### 1. VM Never Actually Created - No Bootstrap Path

**Location:** `/Users/sethwebster/Development/expo/expo-free-agent/free-agent/Sources/BuildVM/VMManager.swift` lines 224-241

**Problem:** The VMManager throws `VMError.invalidHardwareModel` if the HardwareModel file doesn't exist. There's no code path to actually CREATE a VM from scratch - only to USE an existing one.

```swift
if FileManager.default.fileExists(atPath: hardwareModelPath.path) {
    let data = try Data(contentsOf: hardwareModelPath)
    // ...
} else {
    // For first run, need to use supported hardware model
    // This should be set during VM creation process
    throw VMError.invalidHardwareModel  // <-- Always fails on fresh install
}
```

**Impact:** Free Agent cannot work out of the box. User must manually run `create-macos-vm.sh` AND complete 15+ manual setup steps inside the VM (install Xcode, create builder user, configure SSH, etc).

**Solution:** Either:
- A) Document this as a HARD REQUIREMENT before using Free Agent
- B) Add VM creation/bootstrapping to the Swift app
- C) Provide pre-baked VM image for download

### 2. Hardcoded SSH IP Address

**Location:** `/Users/sethwebster/Development/expo/expo-free-agent/free-agent/Sources/BuildVM/XcodeBuildExecutor.swift` line 15

```swift
sshHost: String = "192.168.64.2", // Default NAT IP
```

**Problem:** NAT IP `192.168.64.2` is not guaranteed. Virtualization.framework assigns IPs dynamically. First VM might get `.2`, but if multiple VMs exist or DHCP lease changes, builds fail silently.

**Impact:** SSH connections fail with no clear error. Builds hang at "Waiting for VM to be ready".

**Solution:**
- Use Virtualization.framework's network device to get actual IP
- Or use Bonjour/mDNS discovery
- Or configure static IP inside VM (document in setup)

### 3. SSH Key Not Generated by App

**Location:** `/Users/sethwebster/Development/expo/expo-free-agent/free-agent/Sources/BuildVM/XcodeBuildExecutor.swift` lines 136-139

```swift
private static func defaultSSHKeyPath() -> URL {
    let homeDir = FileManager.default.homeDirectoryForCurrentUser
    return homeDir.appendingPathComponent(".ssh/free_agent_ed25519")
}
```

**Problem:** App expects SSH key at `~/.ssh/free_agent_ed25519` but never creates it. User must run `setup-ssh.sh` manually.

**Impact:** All SSH operations fail with "No such file" or permission errors.

**Solution:** Generate key on first run if missing, or fail fast with clear error message pointing to setup script.

### 4. Controller API Mismatch with Swift Worker

**Location:** `/Users/sethwebster/Development/expo/expo-free-agent/free-agent/Sources/WorkerCore/WorkerService.swift` line 138

```swift
let url = URL(string: "\(configuration.controllerURL)/api/workers/\(workerID)/poll")!
```

**Problem:** Swift worker polls `/api/workers/{id}/poll` but controller expects `/api/workers/poll?worker_id={id}` (query param, not path param).

Compare to mock worker (correct):
```typescript
// mock-worker.ts:118
`${this.config.controllerUrl}/api/workers/poll?worker_id=${this.workerId}`
```

**Impact:** Worker never receives jobs. Builds stuck in "pending" forever.

**Solution:** Fix URL in WorkerService.swift to use query parameter.

### 5. Build Package Download URL Wrong

**Location:** `/Users/sethwebster/Development/expo/expo-free-agent/free-agent/Sources/WorkerCore/WorkerService.swift` line 260

```swift
let url = URL(string: "\(configuration.controllerURL)/api/builds/\(job.id)/package")!
```

**Problem:** Controller serves source at `/api/builds/{id}/source`, not `/package`.

**Impact:** Download fails, build aborts.

**Solution:** Change `/package` to `/source`.

### 6. Missing API Key Header in Swift Worker

**Location:** `/Users/sethwebster/Development/expo/expo-free-agent/free-agent/Sources/WorkerCore/WorkerService.swift` lines 80-109

**Problem:** Worker registration and polling don't include `X-API-Key` header. Controller requires API key for all requests.

**Impact:** All worker requests return 401 Unauthorized.

**Solution:** Add `request.setValue(apiKey, forHTTPHeaderField: "X-API-Key")` to all API calls.

---

## YELLOW Architecture Concerns

### 1. WorkerService.swift Has No API Key Storage

The `WorkerConfiguration` struct doesn't have an `apiKey` field. Even if we add the header, there's no way to configure the API key.

**Location:** `/Users/sethwebster/Development/expo/expo-free-agent/free-agent/Sources/WorkerCore/WorkerConfiguration.swift`

**Solution:** Add `apiKey: String` to WorkerConfiguration.

### 2. Certificate Manager Shell Escaping Issues

**Location:** `/Users/sethwebster/Development/expo/expo-free-agent/free-agent/Sources/BuildVM/CertificateManager.swift` lines 23-24

```swift
let keychainPath = "\\$HOME/Library/Keychains/build.keychain-db"
```

**Problem:** Using `\\$HOME` suggests shell variable expansion, but this is passed through SSH. The escaping is inconsistent - sometimes `\\$HOME`, sometimes `~/`. This will cause path resolution failures.

**Impact:** Keychain creation fails, certificates not installed, builds can't sign apps.

**Solution:** Use consistent path handling - either always expand `$HOME` on the Swift side or always use `~` in commands.

### 3. No Graceful Error Recovery in VM Pipeline

**Location:** `/Users/sethwebster/Development/expo/expo-free-agent/free-agent/Sources/BuildVM/VMManager.swift` lines 85-90

The error handling catches exceptions but doesn't distinguish between recoverable (SSH timeout) and fatal (VM crash) errors.

**Impact:** Transient network issues cause permanent build failures.

**Solution:** Add retry logic for recoverable errors (SSH connection, file transfer) while failing fast on fatal errors (VM crash, invalid config).

### 4. BuildJob Model Missing Fields

**Location:** `/Users/sethwebster/Development/expo/expo-free-agent/free-agent/Sources/WorkerCore/WorkerService.swift` lines 362-366

```swift
public struct BuildJob: Codable, Sendable {
    public let id: String
    public let platform: String
    public let estimatedDuration: Int?
}
```

**Problem:** Controller returns job with `source_url` and `certs_url` fields (see mock worker), but Swift model doesn't decode these.

**Impact:** Worker can't know where to download source/certs.

**Solution:** Add missing fields or fetch them via separate API calls.

---

## GREEN DRY Opportunities

### 1. Duplicate Path Constants

SSH key path defined in both `XcodeBuildExecutor.swift` and `setup-ssh.sh`. Should be single source of truth.

### 2. API Client Pattern

Mock worker and CLI both have similar fetch-with-retry logic. Could share a common HTTP client module.

### 3. Multipart Form Handling

Both `WorkerService.swift` and `api-client.ts` manually construct multipart form data. Consider using libraries.

---

## BLUE Maintenance Improvements

### 1. Missing Unit Tests for Swift Code

The Free Agent app has ZERO tests. `Package.swift` declares `FreeAgentTests` target but no tests exist.

**Impact:** Every change requires manual testing with real VMs (30+ minute feedback loop).

**Solution:** Add unit tests with mocked SSH executor and VM manager.

### 2. No Logging Infrastructure

Swift code uses `print()` statements. No log levels, no persistence, no way to debug production issues.

**Solution:** Add OSLog or similar logging framework with debug/info/error levels.

### 3. Hardcoded Timeouts

Timeouts scattered throughout:
- SSH wait: 120s
- Command timeout: varies
- Build timeout: 4 hours

Should be centralized in configuration.

### 4. No Health Check in Swift App

Worker has no way to report its own health. Controller can't distinguish "worker crashed" from "worker building slowly".

---

## WHITE Nitpicks

### 1. Swift 6 Warnings

Build shows warning about missing test target path. Configure properly in Package.swift.

### 2. Unused Imports

`CertificateManager.swift` imports `Security` but doesn't use any Security framework APIs directly.

### 3. Inconsistent Error Types

Some errors are enums, some are strings, some are thrown, some are returned. Standardize on Result type or throws.

---

## CHECKMARK Strengths

### 1. Clean Architecture Separation

Controller has proper separation: API routes, services, database, domain models.

### 2. Comprehensive Test Coverage for TypeScript

Controller and CLI have thorough integration tests covering happy paths and error cases.

### 3. Mock Worker Enables Testing

The mock worker is well-designed and accurately simulates the build protocol.

### 4. Security Considerations

- API key authentication implemented
- Path traversal protection in CLI downloads
- Certificates deleted after build
- Ephemeral VM design protects user code

### 5. Swift Code Compiles Clean

Despite never being run, the Swift code compiles with zero errors (just one warning about test path).

---

## Priority Action Plan

### Phase 1: Make Swift Worker Actually Work (MUST DO FIRST)

| Task | Effort | Impact |
|------|--------|--------|
| Fix poll URL (query param) | 10 min | Critical |
| Fix source download URL | 5 min | Critical |
| Add API key to WorkerConfiguration | 15 min | Critical |
| Add X-API-Key header to all requests | 30 min | Critical |
| Add missing BuildJob fields | 15 min | Critical |

**Total:** ~1.5 hours

### Phase 2: Fix VM Communication

| Task | Effort | Impact |
|------|--------|--------|
| Document/verify SSH IP discovery | 1 hour | Critical |
| Fix shell escaping in CertificateManager | 30 min | High |
| Add SSH key generation or clear error | 30 min | High |

**Total:** ~2 hours

### Phase 3: Create First Real Build

| Task | Effort | Impact |
|------|--------|--------|
| Run create-macos-vm.sh | 1 hour | Prerequisite |
| Manual VM setup (Xcode, SSH, etc) | 2-4 hours | Prerequisite |
| Test SSH connectivity from host | 30 min | Validation |
| Create minimal test Expo project | 15 min | Test fixture |
| Submit build via CLI | 15 min | Integration |
| Debug and iterate | 2-4 hours | Variable |

**Total:** 6-10 hours

### Phase 4: Stabilization

| Task | Effort | Impact |
|------|--------|--------|
| Add retry logic for transient failures | 2 hours | Reliability |
| Add logging infrastructure | 2 hours | Debugging |
| Add basic unit tests for Swift | 4 hours | Maintenance |
| Document setup process end-to-end | 2 hours | Adoption |

**Total:** 10 hours

---

## Biggest Risks/Blockers

### 1. VM Setup Complexity

Manual setup requires 15+ steps inside VM. Any mistake = start over. No validation that setup is correct until build fails.

**Mitigation:** Create verification script that checks: SSH works, Xcode installed, builder user exists, keychain accessible.

### 2. Apple Silicon Only

Virtualization.framework requires Apple Silicon. No Intel Mac support.

**Mitigation:** Document clearly. Consider fallback to cloud builders for Intel.

### 3. Xcode Installation

Xcode is 20GB+ download. Installing inside VM after macOS install takes hours. No automation exists.

**Mitigation:**
- Pre-bake VM image with Xcode
- Or use `xcode-select --install` for CLI tools only (may be sufficient for eas build)

### 4. macOS Licensing

Apple's EULA restricts macOS virtualization. Using community Macs for distributed builds may violate EULA.

**Mitigation:** Consult Apple licensing. Expo may need special arrangement.

---

## Recommended Next Steps

1. **Fix the 5 critical Swift bugs** (1.5 hours) - Makes worker functional
2. **Create one working VM** manually (4-6 hours) - Proves concept
3. **Run first real build** (2-4 hours debugging) - End-to-end validation
4. **Document what worked** - Enable others to replicate
5. **Add tests and logging** - Make debugging sustainable

**Estimated time to first real build:** 8-12 hours focused work

---

## Unresolved Questions

1. How handle VM IP discovery reliably? Static IP or dynamic discovery?
2. Pre-bake VM image or script full setup?
3. Xcode CLI tools sufficient or need full Xcode.app?
4. How handle Apple Developer cert distribution to workers securely?
5. What's minimum Expo app complexity to test E2E?
